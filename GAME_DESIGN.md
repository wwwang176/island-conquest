# Island Conquest — 3D FPS 佔領遊戲規劃書

## 1. 遊戲概述

- **類型**：第一人稱射擊（FPS）+ 旗幟佔領
- **平台**：網頁瀏覽器（WebGL）
- **連線**：單機，無需連線
- **技術棧**：Three.js + Cannon.js
- **美術風格**：Low-poly 熱帶島嶼

### 勝利條件

兩支隊伍（A / B）爭奪地圖上 5 面旗幟，佔領旗幟持續累積分數，先達到 **500 分** 的隊伍獲勝。

---

## 2. 技術架構

```
project-root/
├── index.html
├── src/
│   ├── main.js                 # 入口、遊戲循環
│   ├── core/
│   │   ├── Game.js             # 遊戲主控制器（狀態機）
│   │   ├── InputManager.js     # 鍵鼠輸入
│   │   └── EventBus.js         # 事件系統（擊殺通知、佔領事件等）
│   ├── world/
│   │   ├── Island.js           # 地圖生成（地形、海水、植被）
│   │   ├── CoverSystem.js      # 掩體註冊表（位置、朝向、防護等級）
│   │   ├── FlagPoint.js        # 旗幟據點邏輯
│   │   └── NavMesh.js          # AI 尋路用的導航網格
│   ├── entities/
│   │   ├── Player.js           # 玩家控制器（FPS 相機、移動、射擊）
│   │   ├── Soldier.js          # 通用士兵（血量、武器、動畫狀態）
│   │   └── Weapon.js           # 步槍（彈匣、射擊、換彈、彈道偏移）
│   ├── ai/
│   │   ├── BehaviorTree.js     # 行為樹引擎
│   │   ├── Personality.js      # 個性系統（影響決策權重）
│   │   ├── SquadManager.js     # 小隊管理（3 人一組、任務分配）
│   │   ├── ThreatAssessment.js # 威脅評估（距離、掩體、人數）
│   │   └── AimSimulator.js     # 擬人化瞄準（反應延遲、偏移）
│   ├── systems/
│   │   ├── ScoreManager.js     # 計分系統（佔領持續給分）
│   │   ├── SpawnSystem.js      # 重生系統（隊友 / 旗幟復活點）
│   │   └── PhysicsWorld.js     # Cannon.js 物理包裝
│   └── ui/
│       ├── HUD.js              # 準心、彈藥、血量
│       ├── Minimap.js          # 小地圖
│       ├── Scoreboard.js       # 隊伍分數
│       └── KillFeed.js         # 右上角擊殺通知
```

---

## 3. 遊戲流程

```
遊戲載入
  │
  ├── ① 噪聲生成地形高度圖
  ├── ② 根據規則擺放掩體（確保旗幟周圍有掩護）
  ├── ③ 用 recast-navigation 即時建構 NavMesh（約 1~2 秒）
  ├── ④ CoverSystem 註冊所有掩體位置
  └── ⑤ 遊戲開始（直接開打，無前置流程）
        │
        ▼
  觀察者模式（預設）
  ├── [Tab] 切換觀察目標（第一人稱跟隨某個 AI）
  ├── [V] 切換俯視全景模式（可拖曳 / 縮放看全地圖）
  └── [1] 加入 A 隊 / [2] 加入 B 隊
        │
        ▼
  玩家模式（FPS）
  └── [Esc] 回到觀察者模式
        │
        ▼
  任一隊伍達 500 分 → 彈出提示遊戲結束 → 暫停遊戲
```

---

## 4. 操作控制

| 按鍵 | 功能 |
|---|---|
| W / A / S / D | 移動（前 / 左 / 後 / 右） |
| 滑鼠移動 | 瞄準方向 |
| 滑鼠左鍵 | 射擊 |
| R | 換彈匣 |
| Space | 跳躍 |
| Tab | 觀察者：切換觀察目標 |
| V | 觀察者：俯視 / 第一人稱切換 |
| 1 | 加入 A 隊 |
| 2 | 加入 B 隊 |
| Esc | 回到觀察者模式 |

**移動與瞄準獨立**：下半身控制移動方向（WASD / AI 路徑），上半身控制瞄準方向（滑鼠 / AI 目標追蹤）。可以邊左跑邊右打、後退射擊等。

---

## 5. 地圖設計

### 基本資訊

- **類型**：熱帶島嶼
- **尺寸**：約 300m × 120m
- **地形生成**：程式化噪聲生成，每局地圖不同
- **旗幟分佈**：線性（類似戰地風雲）

### 地圖大致佈局

```
海水 ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

[A 重生] --- 棕櫚林 --- [旗A] --- 沙灘碉堡 --- [旗B] ---
叢林丘陵 --- [旗C 中央高地] --- 廢棄村落 --- [旗D] ---
岩石海岸 --- [旗E] --- 碼頭倉庫 --- [B 重生]

海水 ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
```

### 掩體類型

| 掩體 | 防護等級 | 特性 |
|---|---|---|
| 岩石 | 全掩護 (1.0) | 不可破壞 |
| 木箱 / 沙包 | 半掩護 (0.5) | 部分遮蔽 |
| 棕櫚樹 | 僅遮蔽視線 (0.2) | 不擋子彈 |
| 建築物 | 全掩護 (1.0) | 可進入、多角度掩護 |

每個掩體在 CoverSystem 中註冊：`{ position, normal, coverLevel: 0~1, slots: N }`

---

## 6. 旗幟佔領機制

| 項目 | 值 |
|---|---|
| 佔領半徑 | 8m |
| 佔領時間 | 10 秒（1 人） |
| 多人加速 | 每多 1 人加速 30% |
| 爭奪中 | 敵我同時在圈內 → 進度暫停（Contested） |
| 給分方式 | 每 3 秒，每面己方旗幟 +1 分 |
| 勝利分數 | 500 分 |
| 預估單局 | 約 8~12 分鐘 |

### 旗幟狀態

```
Neutral → Contested → Capturing → Captured(A/B)
```

### 視覺表現

- 旗幟上方顯示佔領進度條
- 旗幟顯示目前所屬隊伍的顏色色塊

---

## 7. 武器系統 — 突擊步槍

| 屬性 | 值 |
|---|---|
| 彈匣容量 | 30 發 |
| 備用彈藥 | 無限 |
| 射速 | 600 RPM（每 100ms 一發） |
| 換彈時間 | 2.5 秒 |
| 傷害 | 25（4 發擊殺） |
| 爆頭倍率 | ×2（2 發擊殺） |
| 射程衰減 | 50m 後傷害遞減 |
| 命中判定 | Hitscan（射線即中） |
| 後座力 | 連射越久隨機偏移越大 |

---

## 8. 士兵與生存系統

| 項目 | 值 |
|---|---|
| 血量 | 100 HP |
| 回血延遲 | 5 秒未受傷 |
| 回血速度 | 每秒 +10 HP |
| 死亡等待 | 5 秒 |
| 友傷 | 關閉 |

### 重生選擇

- **隊友身邊**：該隊友 5 秒內未交戰
- **己方旗幟**：距旗幟隨機 10~15m 處

### 隊伍辨識

- 純粹以角色顏色區分隊伍（無 HUD 名牌標記、無敵方紅色標記）

### 受傷反饋

- 畫面邊緣閃紅光 + 方向指示（被左邊攻擊則左邊閃紅）

---

## 9. 隊伍與小隊編制

### 基本編制

- 每隊 **12 名 COM**
- 玩家加入後為 **12 COM + 1 玩家**（共 13 人）
- 每隊 **4 小隊 × 3 人**

### 小隊配置

| 小隊 | 組成 |
|---|---|
| Alpha | Captain, Support, Rusher |
| Bravo | Captain, Flanker, Support |
| Charlie | Captain, Defender, Sniper |
| Delta | Captain, Rusher, Flanker |

---

## 10. AI 系統

### 10.1 行為樹

```
Root (Selector)
├── [死亡] → 等待重生 → 選擇重生點
├── [受到攻擊] → 風險評估
│   ├── 風險高 → 尋找掩體 → 躲避 → 反擊 / 呼叫支援
│   └── 風險低 → 邊移動邊還擊
├── [小隊任務] → SquadManager 指派
│   ├── 進攻旗幟 → 移動到目標旗 → 清場 → 佔領
│   ├── 防守旗幟 → 選擇掩體位置 → 監視方向
│   └── 支援隊友 → 移動到隊友位置 → 協同交火
└── [閒置] → 巡邏 / 移向最近未佔旗幟
```

### 10.2 六種 AI 個性

| 個性 | 進攻權重 | 防守權重 | 冒險程度 | 風險門檻 | 特徵 |
|---|---|---|---|---|---|
| Rusher | 0.9 | 0.1 | 高 | 0.75 | 衝鋒佔點，不太躲掩體 |
| Defender | 0.2 | 0.9 | 低 | 0.45 | 死守己方旗幟 |
| Flanker | 0.7 | 0.2 | 中高 | 0.65 | 繞後偷襲，走非主路線 |
| Support | 0.5 | 0.5 | 中 | 0.55 | 跟隨小隊，優先支援隊友 |
| Sniper | 0.4 | 0.6 | 低 | 0.50 | 遠距離交戰，選高處掩體 |
| Captain | 0.6 | 0.4 | 中 | 0.60 | 小隊長，決定小隊目標 |

> 風險門檻：總風險分數超過此值時，COM 才會決定找掩體。

### 10.3 小隊系統

- 每隊 4 小隊 × 3 人
- 每小隊有 1 個 Captain，決定小隊當前目標（攻 / 守哪面旗）
- 小隊成員保持 5~15m 間距
- 移動方向與瞄準方向獨立（可邊移動邊開火）

### 10.4 擬人化瞄準（AimSimulator）

| 參數 | 值 |
|---|---|
| 反應時間 | 200~400ms（發現敵人到開始射擊的延遲） |
| 初始偏移 | 瞄準敵人時先偏移 → 逐漸修正到目標 |
| 連射偏移 | 模擬後座力，偏移隨連射增加 |
| 追蹤延遲 | 敵人移動時，瞄準點稍微落後 |

---

## 11. AI 感知與情報系統

### 11.1 視覺系統（Vision）

- **FOV**：120°
- **最大視距**：80m
- **偵測方式**：Raycast 射線檢測
- **更新頻率**：每 200ms（分批輪替更新）
- **辨識延遲**：200~500ms（受距離、敵人狀態影響）

### 11.2 記憶系統（Memory）

每個 COM 對每個已知敵人維護一筆 `EnemyContact` 記錄：

```
EnemyContact {
  enemyId         // 敵人 ID
  status          // "visible" | "lost" | "suspected" | "cleared"
  lastSeenPos     // 最後看到的位置
  lastSeenTime    // 最後看到的時間
  lastSeenVelocity // 消失時的移動方向
  threatLevel     // 威脅等級 0~1
  confidence      // 信心 0~1
}
```

### 狀態轉換

```
看到敵人 → VISIBLE → 敵人消失 → LOST → 時間衰減 → SUSPECTED → 確認安全 → CLEARED
```

### 信心衰減

- 0~3 秒：高信心（很可能還在原位）
- 3~8 秒：中信心（可能已移動）
- 8~15 秒：低信心（不確定）
- 15 秒+：歸零（需重新偵察）

### 11.3 隊伍情報網（TeamIntel）

- 每隊一個共享情報池 `TeamIntelBoard`
- COM 可上傳 / 查詢 / 更新情報
- **即時共享，無延遲、無信心衰減、無偏移**（最強 COM 設定）
- 情報內容：敵人最後位置、移動方向、威脅等級

### 11.4 戰術反應

當敵人消失在掩體後：

1. 標記 lastSeenPos + 移動方向
2. 預測可能位置（扇形展開）
3. 通報小隊
4. 小隊長決策：
   - **人多**：正面壓制 + 側翼包抄
   - **勢均力敵**：維持距離，瞄準掩體邊緣等待
   - **劣勢**：標記危險區域，暫時迴避

### 11.5 掩體邊緣預瞄（Pre-aim）

COM 不會盯著掩體看，而是瞄準敵人最可能探頭的位置：
- 根據消失時的移動方向（權重最高）
- 掩體幾何形狀（哪邊容易露出）
- 掩體後方路線（可能從哪裡繞出）

---

## 12. AI 風險評估系統

### 12.1 五維度風險評分

```
總風險 = 0.30×暴露度 + 0.30×威脅火力 + 0.20×受傷狀態 + 0.15×數量劣勢 + 0.05×任務壓力
```

更新頻率：每 300ms，被攻擊時立即觸發。

### 12.2 暴露度（Exposure）— 權重 0.30

- 從自身位置向周圍 12 方向（每 30°）發射偵測射線
- 3m 內有掩體 → 該方向「有掩護」
- 已知敵人方向的暴露 ×3 倍權重，背面 ×0.5 倍
- 自動計算最佳朝向，取最低暴露度

### 12.3 威脅火力（Incoming Threat）— 權重 0.30

```
單一敵人威脅 = 視線通暢度 × 距離係數 × 注意力係數
```

- 視線通暢度：直接看到 1.0 / 部分遮擋 0.3 / 完全掩體 0.0
- 距離係數：0~15m=1.0 / 15~40m=0.7 / 40~60m=0.4 / 60m+=0.2
- 注意力係數：對我開火 1.0 / 面朝我方向 0.6 / 背對我 0.1

### 12.4 受傷狀態（Health Risk）— 權重 0.20

```
healthRisk = 1.0 - (currentHP / 100)
```

### 12.5 數量劣勢（Outnumbered）— 權重 0.15

```
outnumbered = clamp((enemies - allies) / 4, 0, 1)
```

以 40m 範圍內的友軍 / 已知敵軍計算。

### 12.6 任務壓力（Mission Priority）— 權重 0.05

- 佔領旗幟中 → 0.0（願意承受風險）
- 巡邏中 → 0.5
- 無任務 → 1.0

### 12.7 風險等級與對應行為

| 風險範圍 | 等級 | 行為 |
|---|---|---|
| 0.0 ~ 0.3 | 安全 | 繼續任務，不特別反應 |
| 0.3 ~ 0.6 | 警戒 | 邊打邊注意掩體位置 |
| 0.6 ~ 0.85 | 高風險 | 找掩體 + 交火 + 呼叫支援 |
| 0.85 ~ 1.0 | 極度危險 | 立刻衝向掩體，停止射擊，全力求生 |

> 以上門檻受個性影響，例如 Rusher 的門檻上調（更敢衝）。

### 12.8 掩體選擇邏輯

當 COM 決定找掩護時，從 CoverSystem 搜尋並評分：

```
掩體評分 = 防護品質 × 0.4 + 距離近度 × 0.3 + 方向正確度 × 0.2 + 路線安全度 × 0.1
```

- 防護品質：掩體 coverLevel
- 距離近度：越近越好（避免跑太遠死在路上）
- 方向正確度：掩體在敵人與自己之間
- 路線安全度：跑過去的路線不經過敵人火線

---

## 13. 觀察者模式

### 第一人稱觀察

- [Tab] 在所有 COM 之間切換
- 以被觀察 COM 的第一人稱視角觀看
- 可以觀察雙方任何 COM

### 俯視模式

- [V] 切換為俯視全景
- 可拖曳平移 / 滾輪縮放
- 顯示所有隊伍所有人的位置（不偏袒）

### 加入遊戲

- [1] 加入 A 隊 / [2] 加入 B 隊
- 加入後為 12 COM + 1 玩家 = 13 人
- [Esc] 可退回觀察者模式

---

## 14. HUD 設計

```
┌─────────────────────────────────────────────────┐
│ [小地圖]                    [擊殺通知 右上角]     │
│  ┌─────┐                   PlayerX → EnemyY      │
│  │ · · │                   BotA → BotB            │
│  │  ★  │                                          │
│  └─────┘                                          │
│                                                    │
│            隊伍分數: A 234 ━━━━━ B 189             │
│                                                    │
│                                                    │
│                     +  ← 準心                      │
│                                                    │
│                                                    │
│                              ┌──────────┐          │
│                              │ AR-15    │          │
│                              │ 24/30    │          │
│                              └──────────┘          │
└─────────────────────────────────────────────────┘
```

### 小地圖

- 己方：藍色點
- 敵方：紅色點（開槍時短暫顯示）
- 旗幟：星號 + 所屬隊伍顏色

---

## 15. 效能策略

### AI 分批更新

```
每幀 AI 更新預算分配（24 個 COM）：
  幀 1: A_01~A_04 更新視覺 + 記憶
  幀 2: A_05~A_08 更新視覺 + 記憶
  幀 3: A_09~A_12 更新視覺 + 記憶
  幀 4: B_01~B_04 更新視覺 + 記憶
  幀 5: B_05~B_08 更新視覺 + 記憶
  幀 6: B_09~B_12 更新視覺 + 記憶
  幀 7: 全隊戰術決策更新（每 500ms 一次）
```

- 每個 COM 約每 100ms 更新一次視覺
- 戰術決策每 500ms 一次
- 風險評估每 300ms 一次，被攻擊立即觸發

### NavMesh

- 使用 recast-navigation WASM 版
- 每局開始時根據程式生成地形即時建構（約 1~2 秒）

---

## 16. 開發階段

| 階段 | 內容 | 里程碑 |
|---|---|---|
| **P1** | Three.js 場景 + FPS 相機 + 移動 + 物理 | 能在空白場景中跑動跳躍 |
| **P2** | 武器系統（射擊、換彈、後座力、Hitscan） | 能射擊並看到彈著點 |
| **P3** | Low-poly 島嶼地圖 + 掩體 + 旗幟 | 能在島嶼上跑動，看到 5 面旗 |
| **P4** | 計分系統 + 佔領機制 + 重生 | 站在旗幟旁能佔領並累積分數 |
| **P5** | AI 導航 + 行為樹 + 個性系統 | COM 能自主移動、佔旗、交戰 |
| **P6** | 小隊系統 + 協同戰術 + 威脅評估 | 3 人小隊協同作戰 |
| **P7** | HUD（小地圖、分數、彈藥、擊殺通知） | 完整遊戲 UI |
| **P8** | 觀察者模式（第一人稱跟隨 + 俯視） | 可觀察 AI 行為 |
| **P9** | 平衡調校 + 效能優化 | 24 個 AI 流暢運行 |

---

## 17. 未來擴充（已規劃但暫不實作）

- [ ] 衝刺（Shift 加速跑）
- [ ] 蹲下功能
- [ ] 投擲武器（手榴彈）
- [ ] 地面補給品（血包、彈藥）
- [ ] 音效系統
- [ ] 前置選擇畫面
